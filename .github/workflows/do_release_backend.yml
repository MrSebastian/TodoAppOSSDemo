name: doBackendRelease

on:
  workflow_dispatch:
    inputs:
      release-version:
        required: true
        description: release version
      development-version:
        required: true
        description: next development version
      release-tag:
        required: true
        description: git tag for release

jobs:
  prepare-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
      #        with:
      #          ref: ${{ github.event.inputs.branch }}
      - name: Setup git user
        uses: fregante/setup-git-user@v2
      - name: Install Java and Maven
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: "temurin"
          cache: 'maven'
          cache-dependency-path: 'backend/pom.xml' # optional
      - name: Perform maven release
        run: >
          mvn -B -ntp release:prepare -f backend/pom.xml
          -DreleaseVersion=${{ github.event.inputs.release-version }} 
          -DdevelopmentVersion=${{ github.event.inputs.development-version }} 
          -Dtag=${{ github.event.inputs.release-tag }} 
          -Darguments="-DskipTests"
  
  
  publish-image:
    needs: prepare-release
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: write
    steps:
      - name: checkout release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.release-tag }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: 'maven'
          cache-dependency-path: 'backend/pom.xml' # optional

      - name: Build with Maven
        run: mvn -B -ntp verify -f backend/pom.xml

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            backend/target/*.jar
          tag_name: ${{ github.event.inputs.release-tag }}
          draft: false
          prerelease: false
          generate_release_notes: false

#  release-mvn-artifact:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v4
#
#      - name: Setup git user
#        uses: fregante/setup-git-user@v2
#
#      - name: Set up JDK 17
#        uses: actions/setup-java@v4
#        with:
#          cache: "maven"
#          java-version: '17'
#          distribution: 'temurin'
#
#      - name: Perform maven release
#        run: >
#          mvn -B -ntp release:prepare release:perform -f backend/pom.xml
#          -DreleaseVersion=${{ github.event.inputs.release-version }}
#          -DdevelopmentVersion=${{ github.event.inputs.development-version }}
#          -Dtag=${{ github.event.inputs.release-tag }}
#          -Darguments="-DskipTests"